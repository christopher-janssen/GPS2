---
title: "mph_derivative"
author: "Christopher Janssen"
date: "`r lubridate::today()`"
format: html
editor_options:
  chunk_output_type: console
editor:
  markdown:
    wrap: 72
---

## Introduction

This QMD is designed to orient one to our decision in setting the
stationary threshold at 4mph.

## Source Scripts

```{r setup}
#| message: false
#| warning: false

source("scripts/r/global_setup.R")
library(htmlwidgets)

ggplot2::theme_set(theme_bw()) 

# Bootstrap GPS2 environment with modern functions
source("scripts/r/bootstrap.R")
bootstrap_gps2_environment()
source("scripts/r/gps_processing.R")
```

```{r load-raw-data}
# Load raw GPS data from research drive
raw_gps <- read_csv(here::here(path_shared, "gps.csv"), show_col_types = FALSE)
```

```{r}
mph_2 <- process_gps(gps_data = raw_gps,
                    stationary_threshold_mph = 2)

mph_4 <- process_gps(gps_data = raw_gps)

mph_6 <- process_gps(gps_data = raw_gps,
                    stationary_threshold_mph = 6)
```

## Visualization of Stationary Parameter Differences

```{r visualize-differences}
# Compare stationary points counts
stationary_counts <- data.frame(
  threshold = c("2 mph", "4 mph", "6 mph"),
  count = c(
    sum(mph_2$movement_state == "stationary", na.rm = TRUE),
    sum(mph_4$movement_state == "stationary", na.rm = TRUE), 
    sum(mph_6$movement_state == "stationary", na.rm = TRUE)
  )
)

# Summary table
knitr::kable(stationary_counts, 
             caption = "Stationary Points Count by Speed Threshold")
```

## Speed Distribution Analysis

```{r speed-distributions}
# Combine all datasets with threshold labels
speed_data <- bind_rows(
  mph_2 |> mutate(threshold = "2 mph"),
  mph_4 |> mutate(threshold = "4 mph"), 
  mph_6 |> mutate(threshold = "6 mph")
) |>
  filter(speed <= 10) # Focus on lower speeds for better visualization

# Create histogram with cutoff lines
ggplot(speed_data, aes(x = speed)) +
  geom_histogram(aes(fill = movement_state), bins = 50, alpha = 0.7) +
  geom_vline(data = data.frame(threshold = c("2 mph", "4 mph", "6 mph"), 
                              cutoff = c(2, 4, 6)),
            aes(xintercept = cutoff), 
            color = "red", linetype = "dashed", size = 1) +
  facet_wrap(~threshold, ncol = 1) +
  scale_fill_manual(values = c("stationary" = "steelblue", "transition" = "orange")) +
  labs(title = "Speed Distributions with Stationary Cutoff Points",
       subtitle = "Red dashed lines show stationary thresholds",
       x = "Speed (mph)",
       y = "Count",
       fill = "Movement State") +
  theme(legend.position = "bottom")
```

```{r density-plots}
# Density plots for better distribution visualization
ggplot(speed_data, aes(x = speed, fill = movement_state)) +
  geom_density(alpha = 0.6) +
  geom_vline(data = data.frame(threshold = c("2 mph", "4 mph", "6 mph"), 
                              cutoff = c(2, 4, 6)),
            aes(xintercept = cutoff), 
            color = "red", linetype = "dashed", size = 1) +
  facet_wrap(~threshold, ncol = 1) +
  scale_fill_manual(values = c("stationary" = "blue", "transition" = "orange")) +
  labs(title = "Speed Density Distributions with Stationary Cutoff Points",
       subtitle = "Red dashed lines show stationary thresholds",
       x = "Speed (mph)",
       y = "Density",
       fill = "Movement State") +
  theme(legend.position = "bottom")
```


