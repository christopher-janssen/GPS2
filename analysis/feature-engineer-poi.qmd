---
title: "Feature Engineer POI Categories"
author: "Christopher Janssen"
date: "`r lubridate::today()`"
format:
  html:
    self-contained: true
editor_options:
  chunk_output_type: console
editor:
  markdown:
    wrap: 72
---

# POI Category Feature Engineering

This notebook creates theory-driven POI categories from raw OSM class/type data for lapse prediction modeling.

## Setup

```{r}
library(tidyverse)
source(here::here("scripts/r/setup.R"))
```

## Load Enriched Data

```{r}
gps_enriched <- read_csv(str_c(path_shared, "/gps_enriched_all.csv"),
                         show_col_types = FALSE)

nrow(gps_enriched)
```

## Create POI Categories

```{r}
gps_enriched <- gps_enriched |>
  mutate(
    pass_poi_category = case_when(
      is.na(pass_class) ~ NA_character_,

      # 1. Alcohol on-premise (consumption venues)
      (pass_class == "amenity" & pass_type %in% c(
        "bar", "pub", "nightclub", "biergarten", "casino", "stripclub"
      )) |
      (pass_class == "craft" & pass_type %in% c("brewery", "distillery", "winery")) ~ "alcohol_on_premise",

      # 2. Alcohol off-premise (retail)
      (pass_class == "shop" & pass_type %in% c("alcohol", "wine")) ~ "alcohol_off_premise",

      # 3. Potential alcohol exposure
      (pass_class == "amenity" & pass_type %in% c(
        "fuel", "restaurant", "theatre", "cinema", "events_venue"
      )) |
      (pass_class == "shop" & pass_type %in% c("supermarket", "convenience")) |
      (pass_class == "leisure" & pass_type %in% c("stadium", "arts_centre")) ~ "potential_alcohol",

      # 4. Food casual (lower alcohol context)
      (pass_class == "amenity" & pass_type %in% c(
        "cafe", "fast_food", "food_court", "ice_cream"
      )) ~ "food_casual",

      # 5. Healthcare
      (pass_class == "amenity" & pass_type %in% c(
        "hospital", "clinic", "doctors", "dentist", "pharmacy",
        "social_facility", "veterinary", "nursing_home"
      )) |
      (pass_class == "healthcare") |
      (pass_class == "emergency" & pass_type %in% c(
        "emergency_ward_entrance", "ambulance_station"
      )) ~ "healthcare",

      # 6. Recreation/fitness (active)
      (pass_class == "leisure" & pass_type %in% c(
        "fitness_centre", "sports_centre", "swimming_pool", "sports_hall",
        "ice_rink", "bowling_alley", "golf_course", "marina", "sauna",
        "dance", "amusement_arcade", "miniature_golf", "track", "water_park",
        "trampoline_park", "escape_game", "indoor_play", "hackerspace",
        "horse_riding", "bandstand"
      )) |
      (pass_class == "amenity" & pass_type %in% c(
        "dojo", "ski_school", "swimming_school", "driving_school"
      )) ~ "recreation_active",

      # 7. Parks/outdoor (green space)
      (pass_class == "leisure" & pass_type %in% c(
        "garden", "playground", "dog_park", "park", "nature_reserve",
        "fishing", "swimming_area", "outdoor_seating", "common"
      )) |
      (pass_class == "tourism" & pass_type %in% c("picnic_site", "camp_pitch")) |
      (pass_class == "natural" & pass_type %in% c("cave_entrance", "spring")) ~ "parks_outdoor",

      # 8. Religious
      (pass_class == "amenity" & pass_type == "place_of_worship") ~ "religious",

      # 9. Education
      (pass_class == "amenity" & pass_type %in% c(
        "school", "college", "university", "kindergarten", "library",
        "music_school", "prep_school", "childcare", "training",
        "cosmetology_school", "makerspace", "research_institute"
      )) |
      (pass_class == "office" & pass_type == "educational_institution") ~ "education",

      # 10. Tourism & Lodging
      (pass_class == "tourism" & pass_type %in% c(
        "hotel", "motel", "guest_house", "hostel", "camp_site", "apartment",
        "chalet", "caravan_site"
      )) ~ "tourism_lodging",

      # 11. Entertainment & Culture (non-alcohol attractions)
      (pass_class == "tourism" & pass_type %in% c(
        "museum", "gallery", "attraction", "viewpoint", "zoo", "aquarium",
        "theme_park", "artwork", "haunted", "monument"
      )) |
      (pass_class == "historic") |
      (pass_class == "amenity" & pass_type %in% c(
        "arts_centre", "community_centre", "conference_centre"
      )) ~ "entertainment_culture",

      # 12. Civic & Community Services
      (pass_class == "amenity" & pass_type %in% c(
        "townhall", "courthouse", "fire_station", "police", "post_office",
        "public_building", "marketplace", "polling_station", "prison",
        "ranger_station", "grave_yard", "social_centre", "public_bookcase",
        "library_dropoff", "bell", "waste_transfer_station"
      )) |
      (pass_class == "office" & pass_type %in% c(
        "government", "political_party", "ngo", "foundation", "charity"
      )) ~ "civic_community",

      # 13. Financial Services
      (pass_class == "amenity" & pass_type %in% c("bank", "atm")) |
      (pass_class == "office" & pass_type %in% c(
        "financial", "financial_advisor", "accountant", "tax_advisor"
      )) |
      (pass_class == "shop" & pass_type == "money_lender") ~ "financial_services",

      # 14. Transportation
      (pass_class == "amenity" & pass_type %in% c(
        "bicycle_rental", "car_rental", "car_sharing", "bus_station",
        "taxi", "ferry_terminal", "boat_rental"
      )) ~ "transportation",

      # 15. Automotive Services
      (pass_class == "amenity" & pass_type == "car_wash") |
      (pass_class == "shop" & pass_type %in% c(
        "car_repair", "car", "car_parts", "tyres", "motorcycle",
        "motorcycle_parts", "motorcycle_repair", "boat"
      )) ~ "automotive",

      # 16. Personal Services
      (pass_class == "shop" & pass_type %in% c(
        "hairdresser", "beauty", "tattoo", "massage", "cosmetics",
        "laundry", "dry_cleaning", "tailor", "optician", "shoe_repair",
        "pet_grooming", "hairdresser_supply", "piercing"
      )) |
      (pass_class == "amenity" & pass_type %in% c(
        "animal_boarding", "animal_shelter", "brothel"
      )) ~ "personal_services",

      # 17. Professional Services & Offices
      (pass_class == "office") |
      (pass_class == "craft") ~ "professional_services",

      # 18. Retail General (all other shops)
      (pass_class == "shop") ~ "retail_general",

      # 19. Residential & Student Housing
      (pass_class == "amenity" & pass_type %in% c(
        "student_accommodation", "fraternity", "sorority", "coworking_space"
      )) ~ "residential_social",

      # 20. Parking (kept separate - may indicate car-based mobility)
      (pass_class == "amenity" & pass_type %in% c(
        "motorcycle_parking", "moped_parking", "parcel_locker"
      )) ~ "parking",

      # 21. Street/Mobile Vendors
      (pass_class == "amenity" & pass_type %in% c(
        "street_vendor", "marketplace", "baking_oven"
      )) ~ "street_vendors",

      # 22. Miscellaneous
      TRUE ~ "other"
    )
  )
```

## Validation: Check for Uncategorized POI

```{r}
# Check what ended up in "other"
gps_enriched |>
  filter(!is.na(pass_class), pass_poi_category == "other") |>
  count(pass_class, pass_type, sort = TRUE) |>
  knitr::kable()
```

## Summary Statistics

### Distribution of POI Categories

```{r}
gps_enriched |>
  filter(!is.na(pass_poi_category)) |>
  count(pass_poi_category, sort = TRUE) |>
  mutate(
    pct_of_poi_matches = round(n / sum(n) * 100, 2),
    pct_of_all_gps = round(n / nrow(gps_enriched) * 100, 2)
  ) |>
  knitr::kable()
```

### Top Types within Each Category

```{r}
gps_enriched |>
  filter(!is.na(pass_poi_category)) |>
  count(pass_poi_category, pass_class, pass_type, sort = TRUE) |>
  group_by(pass_poi_category) |>
  slice_head(n = 5) |>
  knitr::kable()
```

### Verify All Original Types Are Categorized

```{r}
# Count of distinct class-type combinations
original_types <- gps_enriched |>
  filter(!is.na(pass_class)) |>
  distinct(pass_class, pass_type) |>
  nrow()

categorized_types <- gps_enriched |>
  filter(!is.na(pass_class), pass_poi_category != "other") |>
  distinct(pass_class, pass_type) |>
  nrow()

other_types <- gps_enriched |>
  filter(!is.na(pass_class), pass_poi_category == "other") |>
  distinct(pass_class, pass_type) |>
  nrow()

tibble(
  metric = c("Total unique types", "Explicitly categorized", "Fell to 'other'"),
  count = c(original_types, categorized_types, other_types)
) |>
  knitr::kable()
```

## Write Updated Data

```{r}
output_path <- str_c(path_shared, "/gps_enriched_categorized.csv")
write_csv(gps_enriched, output_path)
```

```{r}
file.info(output_path)$size / 1024^2  # Size in MB
```
