---
title: "OSM Data Exploration"
author: "Christopher Janssen"
date: "`r lubridate::today()`"
format:
  html:
    self-contained: true
    toc: true
    toc-depth: 3
    code-fold: show
editor_options:
  chunk_output_type: console
---

# Overview

This notebook provides a comprehensive classification reference for all Points of Interest (POI) in the Wisconsin OpenStreetMap dataset (`public_data.osm_poi`).

**Purpose:** Manual review and filtering of POI types for GPS proximity analysis. For each OSM class, all type values are enumerated with counts and percentages to support decisions about which POI types are relevant for research (e.g., keeping "restaurant" but excluding "waste_basket").

**Data Structure:** OSM POI are organized hierarchically:
- **Class:** High-level category (e.g., amenity, shop, tourism)
- **Type:** Specific feature within class (e.g., restaurant, pharmacy, museum)

Each table shows types sorted by frequency (most common first) with:
- **Type:** Specific POI category
- **Count:** Number of POI with this type in Wisconsin
- **% of Class:** Percentage this type represents within its class

## Setup

```{r setup}
#| message: false
#| warning: false

source(here::here("scripts/r/setup.R"))
source(here::here("scripts/r/connection.R"))
```

## Database Connection

Connect to the geolocation database on the shared VM.

```{r}
# Connect to database
con <- connect_to_db()

# Verify connection
dbGetQuery(con, "SELECT current_database(), current_user, version()")
```

## Table Schema

Check actual column structure in the loaded tables.

```{r}
# OSM POI columns
dbGetQuery(con, "
SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_schema = 'public_data' AND table_name = 'osm_poi'
ORDER BY ordinal_position;
")
```


# Database Overview

## Table Sizes

```{r}
# Get table sizes for public_data schema
table_sizes <- dbGetQuery(con, "
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public_data'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
")

table_sizes |> knitr::kable()
```

## Total POI Count

```{r}
dbGetQuery(con, "SELECT COUNT(*) as total_poi FROM public_data.osm_poi")
```

## Class Distribution

All POI classes in the Wisconsin dataset, showing the number of places, distinct types, and percentage of total POI:

```{r}
class_summary <- dbGetQuery(con, "
SELECT
  class,
  COUNT(*) as n_places,
  COUNT(DISTINCT type) as n_types,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct_of_total
FROM public_data.osm_poi
GROUP BY class
ORDER BY n_places DESC;
")

class_summary |>
  knitr::kable(
    col.names = c("Class", "Places", "Types", "% of Total"),
    format.args = list(big.mark = ",")
  )
```

## Unique Class-Type Combinations

```{r}
dbGetQuery(con, "
SELECT COUNT(DISTINCT class || '_' || type) as unique_combinations
FROM public_data.osm_poi;
")
```

# POI Type Classification

The following sections enumerate all POI types within each class.

Each table shows:
- **Type:** Specific POI category (e.g., restaurant, pharmacy)
- **Count:** Number of POI with this type
- **% of Class:** Percentage this type represents within its class

Types are sorted by count (descending) to highlight the most common features first.

# Detailed Type Breakdowns

## Amenity Types

```{r}
amenity_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'amenity'
GROUP BY type
ORDER BY count DESC;
")

amenity_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Leisure Types

```{r}
leisure_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'leisure'
GROUP BY type
ORDER BY count DESC;
")

leisure_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Man_Made Types

```{r}
man_made_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'man_made'
GROUP BY type
ORDER BY count DESC;
")

man_made_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Shop Types

```{r}
shop_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'shop'
GROUP BY type
ORDER BY count DESC;
")

shop_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Tourism Types

```{r}
tourism_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'tourism'
GROUP BY type
ORDER BY count DESC;
")

tourism_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Historic Types

```{r}
historic_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'historic'
GROUP BY type
ORDER BY count DESC;
")

historic_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Office Types

```{r}
office_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'office'
GROUP BY type
ORDER BY count DESC;
")

office_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Craft Types

```{r}
craft_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'craft'
GROUP BY type
ORDER BY count DESC;
")

craft_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Emergency Types

```{r}
emergency_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'emergency'
GROUP BY type
ORDER BY count DESC;
")

emergency_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Healthcare Types

```{r}
healthcare_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'healthcare'
GROUP BY type
ORDER BY count DESC;
")

healthcare_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Natural Types

```{r}
natural_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'natural'
GROUP BY type
ORDER BY count DESC;
")

natural_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

## Military Types

```{r}
military_types <- dbGetQuery(con, "
SELECT
  type,
  COUNT(*) as count,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as pct
FROM public_data.osm_poi
WHERE class = 'military'
GROUP BY type
ORDER BY count DESC;
")

military_types |>
  knitr::kable(
    col.names = c("Type", "Count", "% of Class"),
    format.args = list(big.mark = ",")
  )
```

# Cleanup

```{r}
# Close database connection
disconnect_db(con)
```
